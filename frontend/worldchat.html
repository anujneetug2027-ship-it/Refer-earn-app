<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>World Chat ‚Äî Ambika Shelf</title>

<style>
:root{
  --bg:#071124;
  --card:#0b1220;
  --muted:#94a3b8;
  --accent:#06b6d4;
  --glass:rgba(255,255,255,0.05);
  --radius:18px;
  font-family: Inter, system-ui;
}

*{box-sizing:border-box;}
html, body {
  height: 100%;
}
  body{
  margin:0;
  background:linear-gradient(180deg,#071124 0%, #071a2b 100%);
  color:#e6eef8;
  display:flex;
  flex-direction:column;
  min-height:100vh;   /* change from height */
  overflow:auto;      /* change from hidden */
  }

/* ================= MENU ================= */

.topbar{
  display:flex;
  justify-content:flex-end;
  padding:10px 20px;
  position:relative;
  z-index:1000;
}

.menu-btn{
  font-size:26px;
  cursor:pointer;
}

.menu{
  position:fixed;
  top:0;
  right:-280px;
  width:260px;
  height:100%;
  background:#0b1220;
  padding:20px;
  transition:.3s;
  z-index:2000;
}

.menu.open{ right:0; }

.menu a{
  display:block;
  padding:14px 0;
  color:#e6eef8;
  text-decoration:none;
}

.close-btn{
  font-size:22px;
  cursor:pointer;
  margin-bottom:10px;
}

/* ================= WRAPPER ================= */

.chat-wrapper{
  flex:1;
  max-width:900px;
  width:100%;
  margin:auto;
  display:flex;
  flex-direction:column;
  position:relative;
}
/* ================= LOGO ================= */

.logo-top{
  text-align:center;
  margin-top:10px;
  margin-bottom:5px;
}

.logo-top img{
  width:150px;
}

/* ================= LOGIN ================= */

#login{
  margin:auto;
  background:var(--card);
  padding:25px;
  border-radius:var(--radius);
  border:1px solid rgba(255,255,255,0.06);
  width:90%;
  max-width:400px;
}

#login input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.1);
  background:var(--glass);
  color:white;
}

button{
  background:linear-gradient(90deg,var(--accent),#60a5fa);
  border:none;
  padding:10px 14px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}

/* ================= CHAT AREA ================= */

#chat{
  display:none;
  flex-direction:column;
  flex:1;
  min-height:0;   /* IMPORTANT for flex scroll */
  }
#messages{
  flex:1;
  overflow-y:auto;

  padding:15px 15px 100px 15px;   /* LEFT RIGHT TOP BOTTOM */

  border-radius:20px;
  border:2px solid rgba(255,255,255,0.08);
  background:transparent;

  display:flex;
  flex-direction:column;
  gap:10px;

  scroll-behavior:smooth;
  -webkit-overflow-scrolling: touch;
}

/* Message bubble */

.message{
  max-width:75%;
  padding:12px 14px;
  border-radius:18px;
  position:relative;
  animation:fadeIn .25s ease;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(5px);}
  to{opacity:1; transform:translateY(0);}
}

.message.self{
  align-self:flex-end;
  background:linear-gradient(90deg,var(--accent),#60a5fa);
  color:#022;
}

.message.other{
  align-self:flex-start;
  background:var(--glass);
}

.msg-time{
  font-size:11px;
  margin-top:5px;
}

.message.self .msg-time{
  color:black;
}

.message.other .msg-time{
  color:var(--muted);
}

/* ================= IMAGE ================= */

.chat-image{
  max-width:220px;
  border-radius:12px;
  margin-top:6px;
  cursor:pointer;
  transition:.2s;
}

.chat-image:hover{
  transform:scale(1.03);
}

/* Animated download */

.download-btn{
  font-size:12px;
  cursor:pointer;
  margin-top:5px;
  display:inline-block;
  color:var(--accent);
  transition:.2s;
}

.download-btn:hover{
  transform:scale(1.15);
}

/* ================= IMAGE PREVIEW ================= */

#previewBox{
  display:none;
  padding:10px;
  margin:0 10px;
}

#previewBox img{
  max-width:120px;
  border-radius:10px;
}

.cancel-preview{
  color:red;
  cursor:pointer;
  font-size:12px;
}

/* ================= INPUT AREA ================= */

.input-area{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#0b1220;
  padding:10px;
  display:flex;
  gap:8px;
  align-items:center;
}

#msg{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.1);
  background:var(--glass);
  color:white;
}

/* Exit button fix mobile */

.exit-btn{
  background:#ef4444;
  color:white;
  padding:10px 12px;
  border-radius:10px;
  white-space:nowrap;
}

@media(max-width:600px){
  .exit-btn{
    padding:8px 10px;
  }
}
.typing-indicator{
  display:flex;
  align-items:center;
  gap:6px;
  margin:5px 15px;
  font-size:13px;
  color:var(--muted);
}

.typing-dots span{
  width:6px;
  height:6px;
  background:var(--muted);
  border-radius:50%;
  display:inline-block;
  animation:blink 1.4s infinite both;
}

.typing-dots span:nth-child(2){
  animation-delay:.2s;
}
.typing-dots span:nth-child(3){
  animation-delay:.4s;
}

@keyframes blink{
  0%{opacity:.2}
  20%{opacity:1}
  100%{opacity:.2}
    }
/* ================= FULL IMAGE MODAL ================= */

#imageModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  justify-content:center;
  align-items:center;
  z-index:3000;
}

#imageModal img{
  max-width:90%;
  max-height:90%;
}
</style>
</head>
<body>

<!-- MENU -->
<div class="topbar">
  <div class="menu-btn" onclick="openMenu()">‚ò∞</div>
</div>

<div id="menu" class="menu">
  <div class="close-btn" onclick="closeMenu()">‚úï</div>
  <a href="/">Login</a>
  <a href="/worldchat">World Chat</a>
</div>

<div class="chat-wrapper">

<div class="logo-top">
  <img src="https://ambikashelf.shop/ambikashelf.png">
</div>

<!-- LOGIN SCREEN -->
<div id="login">
  <h2>Enter Username</h2>
  <input id="username" placeholder="Your name">
  <br><br>
  <button onclick="manualJoin()">Join Chat</button>
</div>

<!-- CHAT -->
<div id="chat">

  <div id="messages"></div>

  <div id="previewBox"></div>

</div>

</div>

<!-- INPUT AREA -->
<div class="input-area">
  <input type="file" id="imageInput" style="display:none">
  <button onclick="document.getElementById('imageInput').click()">üì∑</button>
  <input id="msg" placeholder="Type message">
  <button onclick="askAmbika()">Ask AmbikaShelf</button>
<button onclick="sendMessage()">Send</button>
  <button class="exit-btn" onclick="exitChat()">Exit</button>
</div>

<!-- IMAGE MODAL -->
<div id="imageModal" onclick="closeImageModal()">
  <img id="modalImg">
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let joined=false;
let currentReply=null;
let selectedImage=null;

/* ===== MENU ===== */
function openMenu(){ document.getElementById("menu").classList.add("open"); }
function closeMenu(){ document.getElementById("menu").classList.remove("open"); }

/* ===== COOKIES ===== */
function setCookie(n,v){document.cookie=n+"="+v+";path=/";}
function getCookie(n){const v=`; ${document.cookie}`;const p=v.split(`; ${n}=`);if(p.length===2)return p.pop().split(';').shift();}
function deleteCookie(n){document.cookie=n+"=; Max-Age=0; path=/;";}

/* ===== LOGIN ===== */
function manualJoin(){
  const u=document.getElementById("username").value.trim();
  if(!u)return alert("Enter username");
  setCookie("username",u);
  joinAfterConnect(u);
}

function joinAfterConnect(username){
  if(joined)return;
  socket.emit("join",username);
  joined=true;
  document.getElementById("login").style.display="none";
  document.getElementById("chat").style.display="flex";
}

socket.on("connect",()=>{
  const saved=getCookie("username");
  if(saved){joinAfterConnect(saved);}
});

/* ===== IMAGE PREVIEW BEFORE SEND ===== */
document.getElementById("imageInput").addEventListener("change",function(e){
  const file=e.target.files[0];
  if(!file)return;

  const reader=new FileReader();
  reader.onload=function(ev){
    selectedImage=ev.target.result;
    const box=document.getElementById("previewBox");
    box.style.display="block";
    box.innerHTML=`
      <img src="${selectedImage}">
      <div class="cancel-preview" onclick="cancelPreview()">Cancel</div>
    `;
  };
  reader.readAsDataURL(file);
});

function cancelPreview(){
  selectedImage=null;
  document.getElementById("previewBox").style.display="none";
  document.getElementById("imageInput").value="";
}

/* ===== IMAGE MODAL ===== */
function openImage(src){
  document.getElementById("modalImg").src=src;
  document.getElementById("imageModal").style.display="flex";
}
function closeImageModal(){
  document.getElementById("imageModal").style.display="none";
}
</script>
<script>

/* ================= SOCKET EVENTS ================= */

socket.on("oldMessages", msgs => {
  msgs.forEach(addMessage);
});

socket.on("message", data => {
  addMessage(data);

  const box = document.getElementById("messages");

  const isNearBottom =
    box.scrollHeight - box.scrollTop - box.clientHeight < 120;

  if (isNearBottom) {
    setTimeout(() => {
      box.scrollTo({
        top: box.scrollHeight,
        behavior: "smooth"
      });
    }, 50);
  }

  if(data.user===getCookie("username")){
    const sendAudio = document.getElementById("sendSound");
    if(sendAudio){
      sendAudio.currentTime = 0;
      sendAudio.play().catch(()=>{});
    }
  } else {
    const receiveAudio = document.getElementById("receiveSound");
    if(receiveAudio){
      receiveAudio.currentTime = 0;
      receiveAudio.play().catch(()=>{});
    }
  }
});

socket.on("typing",(user)=>{
  if(user!==getCookie("username")){
    showTyping(user);
  }
});

socket.on("stopTyping",()=>{
  hideTyping();
});

socket.on("reactionUpdate",({id,reactions})=>{
  const msg=document.getElementById("msg-"+id);
  if(!msg)return;
  const reactDiv=msg.querySelector(".reactions");
  reactDiv.innerHTML="";
  Object.keys(reactions).forEach(e=>{
    reactDiv.innerHTML+=`<span class="react-count">${e} ${reactions[e]}</span> `;
  });
});
  /* -----------------------------------*/
  function addMessage(data){

  const box = document.getElementById("messages");

  const div = document.createElement("div");

  const isSelf = data.user === getCookie("username");

  div.className = "message " + (isSelf ? "self" : "other");

  div.id = "msg-" + data.id;

  let replyHTML = "";
  if(data.reply){
    replyHTML = `
      <div style="
        background:rgba(255,255,255,0.08);
        padding:6px;
        border-left:3px solid var(--accent);
        border-radius:8px;
        margin-bottom:6px;
        font-size:13px;">
        ${data.reply}
      </div>
    `;
  }

  let imageHTML = "";
  if(data.image){
    imageHTML = `
      <img src="${data.image}" class="chat-image" onclick="openImage('${data.image}')">
      <div class="download-btn" onclick="downloadImage('${data.image}')">
        ‚¨á Download
      </div>
    `;
  }

  div.innerHTML = `
    ${replyHTML}
    <b>${data.user}:</b> ${data.text || ""}
    ${imageHTML}
    <div class="msg-time">${data.time}</div>
    <div class="reactions"></div>
  `;

  box.appendChild(div);

  addReactionSystem(div, data.id);
  addSwipeReply(div, data.text);
  }

/* ================= SEND MESSAGE ================= */

function sendMessage(){
  const input=document.getElementById("msg");
  const text=input.value.trim();

  if(!text && !selectedImage) return;

  socket.emit("sendMessage",{
    text:text,
    image:selectedImage,
    reply:currentReply
  });

  input.value="";
  cancelPreview();
  clearReply();
}
  /* ------------------------chat bot------------------------ */
  async function askAmbika(){
  const input=document.getElementById("msg");
  const text=input.value.trim();

  if(!text && !selectedImage) return;

  const imageCopy = selectedImage;

  socket.emit("sendMessage",{
    text:text,
    image:imageCopy,
    reply:currentReply
  });

  input.value="";
  cancelPreview();
  clearReply();

  showTyping("AmbikaShelf");

  try{

    const response = await fetch("/ask-ai", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        text: text,
        image: imageCopy
      })
    });

    const data = await response.json();

    hideTyping();

    const aiReply = data.reply;

    socket.emit("sendMessage",{
      text: aiReply,
      isBot: true
    });

  }catch(err){
    hideTyping();

    socket.emit("sendMessage",{
      text:"AmbikaShelf AI error.",
      isBot:true
    });
  }
  }
  
/* ===== SMART AUTO SCROLL ===== */


/* ================= COPY ================= */

function copyText(text){
  if(!text) return;
  navigator.clipboard.writeText(text);
}

/* ================= DOWNLOAD IMAGE ================= */

function downloadImage(src){
  const a=document.createElement("a");
  a.href=src;
  a.download="image.png";
  a.click();
}

/* ================= REACTIONS ================= */

function addReactionSystem(div,id){

  const picker=document.createElement("div");
  picker.className="emoji-picker";
  picker.style.display="none";
  picker.innerHTML=`
    <span onclick="reactMessage(${id},'üëç')">üëç</span>
    <span onclick="reactMessage(${id},'üòÇ')">üòÇ</span>
    <span onclick="reactMessage(${id},'üòÖ')">üòÖ</span>
    <span onclick="reactMessage(${id},'üôè')">üôè</span>
    <span onclick="reactMessage(${id},'üò•')">üò•</span>
  `;
  div.appendChild(picker);

  div.ondblclick=()=>{
    picker.style.display=picker.style.display==="block"?"none":"block";
  };
}

function reactMessage(id,emoji){
  socket.emit("react",{id,emoji});
}

/* ================= SWIPE REPLY ================= */

function addSwipeReply(div,text){
  let startX=0;

  div.addEventListener("touchstart",(e)=>{
    startX=e.touches[0].clientX;
  });

  div.addEventListener("touchend",(e)=>{
    let diff=e.changedTouches[0].clientX-startX;
    if(diff>80){
      currentReply=text;
      showReplyPreview(text);
    }
  });
}

function showReplyPreview(text){
  const preview=document.getElementById("previewBox");
  preview.style.display="block";
  preview.innerHTML=`
    <div style="background:rgba(255,255,255,0.08);padding:8px;border-left:3px solid var(--accent);border-radius:8px;">
      Replying to: ${text}
      <div class="cancel-preview" onclick="clearReply()">Cancel</div>
    </div>
  `;
}

function clearReply(){
  currentReply=null;
  document.getElementById("previewBox").style.display="none";
}

/* ================= TYPING ================= */

let typingTimer;

document.getElementById("msg").addEventListener("input",()=>{
  socket.emit("typing");
  clearTimeout(typingTimer);
  typingTimer=setTimeout(()=>{
    socket.emit("stopTyping");
  },1500);
});
function showTyping(user){
  let box = document.getElementById("typingBox");

  if(!box){
    box = document.createElement("div");
    box.id="typingBox";
    box.className="typing-indicator";
    document.getElementById("chat").appendChild(box);
  }

  box.innerHTML = `
    ${user} is typing
    <div class="typing-dots">
      <span></span><span></span><span></span>
    </div>
  `;
}


function hideTyping(){
  const box=document.getElementById("typingBox");
  if(box) box.remove();
  }

/* ================= EXIT ================= */

function exitChat(){
  deleteCookie("username");
  location.reload();
}
</script>
  <audio id="sendSound" src="https://ambikashelf.shop/send.mp3"></audio>
<audio id="receiveSound" src="https://ambikashelf.shop/recieve.mp3"></audio>
</body>
</html>
